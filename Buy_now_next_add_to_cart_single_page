<?php
// ✅ Add Buy Now button next to Add to Cart
function wpamit_add_buy_now_button_single() {
    global $product;

    // Skip affiliate/external products
    if ( $product->is_type( 'external' ) ) {
        return;
    }

    echo '
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("form.cart");
            const addToCartBtn = form ? form.querySelector(".single_add_to_cart_button") : null;

            if (form && addToCartBtn) {
                const buyNowBtn = document.createElement("button");
                buyNowBtn.type = "submit";
                buyNowBtn.name = "wpamit-buy-now";
                buyNowBtn.value = "' . esc_attr( $product->get_ID() ) . '";
                buyNowBtn.className = "single_add_to_cart_button button alt buy_now_button";
                buyNowBtn.textContent = "Buy Now";

                const wrapper = document.createElement("div");
                wrapper.className = "wpamit-buy-now-wrapper";

                addToCartBtn.parentNode.insertBefore(wrapper, addToCartBtn);
                wrapper.appendChild(addToCartBtn);
                wrapper.appendChild(buyNowBtn);
            }
        });
    </script>

    <style>
        .wpamit-buy-now-wrapper {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .wpamit-buy-now-wrapper .single_add_to_cart_button,
        .wpamit-buy-now-wrapper .buy_now_button {
            flex: 1;
        }
    </style>
    ';
}
add_action( 'woocommerce_after_add_to_cart_button', 'wpamit_add_buy_now_button_single', 20 );


// ✅ Handle Buy Now function
function wpamit_handle_buy_now_action() {
    if ( ! isset( $_POST['wpamit-buy-now'] ) ) {
        return;
    }

    $product_id = absint( $_POST['wpamit-buy-now'] );
    $quantity   = isset( $_POST['quantity'] ) ? absint( $_POST['quantity'] ) : 1;
    $product    = wc_get_product( $product_id );

    if ( ! $product || $product->is_type( 'external' ) ) {
        return;
    }

    // Save current cart in session temporarily
    $current_cart = WC()->cart->get_cart();
    WC()->session->set( 'wpamit_temp_cart', $current_cart );

    // Empty cart for Buy Now
    WC()->cart->empty_cart();

    // Add Buy Now product
    if ( isset( $_POST['variation_id'] ) && $_POST['variation_id'] ) {
        $variation_id = absint( $_POST['variation_id'] );
        WC()->cart->add_to_cart( $product_id, $quantity, $variation_id );
    } else {
        WC()->cart->add_to_cart( $product_id, $quantity );
    }

    // Redirect to checkout
    wp_safe_redirect( wc_get_checkout_url() );
    exit;
}
add_action( 'template_redirect', 'wpamit_handle_buy_now_action' );


// ✅ Restore cart after leaving checkout
function wpamit_restore_cart() {
    if ( ! is_checkout() && WC()->session->__isset( 'wpamit_temp_cart' ) ) {

        $temp_cart = WC()->session->get( 'wpamit_temp_cart' );

        if ( $temp_cart ) {
            WC()->cart->empty_cart();

            // Restore previous cart
            foreach ( $temp_cart as $cart_item ) {
                WC()->cart->add_to_cart(
                    $cart_item['product_id'],
                    $cart_item['quantity'],
                    isset( $cart_item['variation_id'] ) ? $cart_item['variation_id'] : 0,
                    isset( $cart_item['variation'] ) ? $cart_item['variation'] : array(),
                    isset( $cart_item['cart_item_data'] ) ? $cart_item['cart_item_data'] : array()
                );
            }
        }

        WC()->session->__unset( 'wpamit_temp_cart' );
    }
}
add_action( 'template_redirect', 'wpamit_restore_cart' );


// ✅ Disable AJAX hijack
function wpamit_disable_ajax_for_buy_now() {
    ?>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const buyNowBtn = document.querySelector('button[name="wpamit-buy-now"]');

            if (buyNowBtn) {
                buyNowBtn.addEventListener(
                    "click",
                    function (e) {
                        e.stopImmediatePropagation();
                    },
                    true
                );
            }
        });
    </script>
    <?php
}
add_action( 'wp_footer', 'wpamit_disable_ajax_for_buy_now' );
